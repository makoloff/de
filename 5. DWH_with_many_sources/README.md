# Проект 4

## План проекта
Ваша новая задача — реализовать витрину для расчётов с курьерами.

Курьеры работают, доставляют заказы. Вам необходимо рассчитать суммы оплаты каждому курьеру за предыдущий месяц. Например, в июне выплачиваем сумму за май. Расчётным числом является 10-е число каждого месяца.

Необходимо:
- Собрать и проанализировать требования к задаче.
- Изучить возможные источники и их внутреннюю модель хранения данных, а также технологии, которые используются для получения данных из этих источников.
- На основе требований, целей дальнейшего использования, информации об источниках нужно спроектировать многослойную модель DWH, подробно прорабатывая каждый слой данных.

### Основная задача
Реализация ETL-процессов, которые будут преобразовывать и перемещать данные от источников до конечных слоёв данных DWH.

Нужно также подтвердить, что написанный код работает и удовлетворяет требованиям: 
- подготовить тест-кейсы, 
- написать код для тестирования, 
- провести само тестирование.

Для передачи результатов заказчику оформите всю необходимую документацию.

### Описание задачи
Вам необходимо построить витрину, содержащую информацию о выплатах курьерам.

Состав витрины:
- id — идентификатор записи.
- courier_id — ID курьера, которому перечисляем.
- courier_name — Ф. И. О. курьера.
- settlement_year — год отчёта.
- settlement_month — месяц отчёта, где 1 — январь и 12 — декабрь.
- orders_count — количество заказов за период (месяц).
- orders_total_sum — общая стоимость заказов.
- rate_avg — средний рейтинг курьера по оценкам пользователей.
- order_processing_fee — сумма, удержанная компанией за обработку заказов, которая высчитывается как orders_total_sum * 0.25.
- courier_order_sum — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).
- courier_tips_sum — сумма, которую пользователи оставили курьеру в качестве чаевых.
- courier_reward_sum — сумма, которую необходимо перечислить курьеру. Вычисляется как courier_order_sum + courier_tips_sum * 0.95 (5% — комиссия за обработку платежа).

Правила расчёта процента выплаты курьеру в зависимости от рейтинга, где r — это средний рейтинг курьера в текущем месяце:
r < 4 — 5% от заказа, но не менее 100 руб.;
4 <= r < 4.5 — 7% от заказа, но не менее 150 руб.;
4.5 <= r < 4.9 — 8% от заказа, но не менее 175 руб.;
4.9 <= r — 10% от заказа, но не менее 200 руб.

Данные о заказах уже есть в хранилище. Данные курьерской службы вам необходимо забрать из API курьерской службы, после чего совместить их с данными подсистемы заказов.

### Инструкция по выполнению проекта
### 1. Изучите API системы доставки заказов
Спецификация API
#### GET /restaurants
Метод /restaurants возвращает список доступных ресторанов (_id, name). В заголовке запроса нужно указать:
- X-Nickname — ваш никнейм (например, sashanikonov);
- X-Cohort со значением номера вашей когорты (например, 1);
- X-API-KEY со значением 25c27781-8fde-4b30-a22e-524044a7580f. Если не указать верный ключ к API, то вместо ожидаемого результата выйдет ошибка доступа.

Установите предварительно утилиту curl, чтобы с помощью неё обратиться к API. Выполните следующие команды в командной строке:
`curl --location --request GET 'https://d5d04q7d963eapoepsqr.apigw.yandexcloud.net/restaurants?sort_field={{ sort_field }}&sort_direction={{ sort_direction }}&limit={{ limit }}&offset={{ offset }}' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-API-KEY: {{ api_key }}'`

В качестве переменных заголовка, указанных в {{ }}, передайте ваши актуальные данные.
Описание параметров запроса, указанных в {{ }} :
- sort_field — необязательный параметр. Возможные значения: id, name. Значение по умолчанию: id.
Параметр определяет поле, к которому будет применяться сортировка, переданная в параметре sort_direction.
- sort_direction — необязательный параметр. Возможные значения: asc, desc.
Параметр определяет порядок сортировки для поля, переданного в sort_field:
asc — сортировка по возрастанию,
desc — сортировка по убыванию.
- limit — необязательный параметр. Значение по умолчанию: 50. Возможные значения: целое число в интервале от 0 до 50 включительно.
Параметр определяет максимальное количество записей, которые будут возвращены в ответе.
- offset — необязательный параметр. Значение по умолчанию: 0.
Параметр определяет количество возвращаемых элементов результирующей выборки, когда формируется ответ.

Метод возвращает список ресторанов. Каждый ресторан списка содержит:
- _id — ID задачи;
- name — название ресторана.

#### GET /couriers
Метод /couriers используется для того, чтобы получить список курьеров с учётом фильтров, переданных в запросе.
С помощью утилиты curl обратитесь к API:
`curl --location --request GET 'https://d5d04q7d963eapoepsqr.apigw.yandexcloud.net/couriers?sort_field={{ sort_field }}&sort_direction={{ sort_direction }}&limit={{ limit }}&offset={{ offset }}' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-API-KEY: {{ api_key }}' `

Параметры /couriers аналогичны параметрам в предыдущем методе: sort_field, sort_direction, limit, offset.
Метод возвращает список курьеров. Каждый элемент списка содержит:
- _id — ID курьера в БД;
- name — имя курьера.

#### GET / deliveries
Метод /deliveries используется для того, чтобы получить список совершённых доставок с учётом фильтров, переданных в запросе.
С помощью утилиты curl обратитесь к API:
`curl --location --request GET 'https://d5d04q7d963eapoepsqr.apigw.yandexcloud.net/deliveries?restaurant_id={{ restaurant_id }}&from={{ from }}&to={{ to }}&sort_field={{ sort_field }}&sort_direction={{ sort_direction }}&limit={{ limit }}&offset={{ limit }}' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-API-KEY: {{ api_key }}' `

Параметры метода также включают sort_field, sort_direction, limit, offset и несколько дополнительных полей:
- sort_field — необязательный параметр. Возможные значения: _id, name. Если указать _id, то сортировка будет применяться к ID заказа (order_id). Если указать date, то сортировка будет применяться к дате создания заказа (order_ts).
- restaurant_id — ID ресторана. Если значение не указано, то метод вернёт данные по всем доступным в БД ресторанам.
- from и to — параметры фильтрации. В выборку попадают заказы с датой доставки между from и to.

Метод возвращает список совершённых доставок с учётом фильтров в запросе. Каждый элемент списка содержит:
- order_id — ID заказа;
- order_ts — дата и время создания заказа;
- delivery_id — ID доставки;
- courier_id — ID курьера;
- address — адрес доставки;
- delivery_ts — дата и время совершения доставки;
- rate — рейтинг доставки, который выставляет покупатель. Целочисленное значение от 1 до 5;
- sum — сумма заказа (в руб.);
- tip_sum — сумма чаевых, которые оставил покупатель курьеру (в руб.).

### 2. Спроектируйте структуру таблиц для слоёв в хранилище
Вы обладаете полной информацией о том, какая информация нужна, чтобы построить витрину. Часть этой информации уже есть в хранилище данных, часть — надо будет загрузить из API.

Cпроектируйте структуру таблиц для трёх слоёв, заведённых в вашем хранилище.
2.1. Спроектируйте структуру витрины расчётов с курьерами
На основе информации, уже имеющейся в хранилище, а также новых данных, изученных в API подсистемы доставки, спроектируйте структуру витрины данных.
В качестве результата проектирования оформите DDL-запрос для создания витрины. Назовите витрину cdm.dm_courier_ledger.
2.2. Спроектируйте структуру DDS-слоя
В детальном слое необходимо разложить данные из подсистемы доставки по модели «снежинка». Составьте список таблиц, которые необходимо добавить в хранилище, а также спроектируйте структуру этих таблиц.
Обратите внимание, что вам нужно будет не только создать новые таблицы, но и изменить уже существующие.
Составьте DDL-скрипт для формирования новой структуры DDS-слоя.
2.3. Спроектируйте структуру STG-слоя.
STG-слой отражает сырые данные, полученные вами из API подсистемы доставки. Данные в STG-слое должны быть максимально похожи на данные, которые вы получаете из API.
### 3. Реализуйте DAG
Следующим шагом реализуйте DAG, который наполнит все слои хранилища данными.
3.1. Реализуйте заполнение STG-слоя
Создайте DAG, который будет заполнять таблицы staging-слоя данными из API.
3.2. Реализуйте заполнение DDS-слоя
Дополните DAG, чтобы заполнять таблицы DDS-слоя данными из STG-слоя.
3.2. Реализуйте заполнение CDM-слоя
Дополните DAG ещё раз, чтобы заполнять витрины.






### Как запустить контейнер
Запустите локально команду:

```
docker run \
-d \
-p 3000:3000 \
-p 3002:3002 \
-p 15432:5432 \
--mount src=airflow_sp5,target=/opt/airflow \
--mount src=lesson_sp5,target=/lessons \
--mount src=db_sp5,target=/var/lib/postgresql/data \
--name=de-sprint-5-server-local \
sindb/de-pg-cr-af:latest
```

После того как запустится контейнер, вам будут доступны:
- Airflow
	- `localhost:3000/airflow`
- БД
	- `jovyan:jovyan@localhost:15432/de`
