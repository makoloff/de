# Проект 3

## Исходные данные
Новые инкременты с информацией о продажах приходят по API, спецификация к которому лежит ниже, и содержат статус заказа (shipped/refunded).

### Спецификация API
#### POST /generate_report

Метод /generate_report инициализирует формирование отчёта. В заголовке запроса нужно указать:
X-Nickname — ваш никнейм (например, sashanikonov).
X-Project со значением True — так мы узнаем, что вы выполняете итоговый проект.
X-Cohort со значением номера вашей когорты (например, 1).
X-API-KEY со значением 5f55e6c0-e9e5-4a9c-b313-63c01fc31460. Если не указать верный ключ к API, то вместо ожидаемого результата выйдет ошибка доступа.
Установите предварительно утилиту curl, чтобы с помощью неё обратиться к API. Выполните следующие команды в командной строке:

`curl --location --request POST 'https://d5dg1j9kt695d30blp03.apigw.yandexcloud.net/generate_report' \
--header 'X-Nickname: {{ your_nickname }}' \
--header 'X-Cohort: {{ your_cohort_number }}' \
--header 'X-Project: True' \
--header 'X-API-KEY: {{ api_key }}' \
--data-raw ''`

В качестве переменных, указанных в {{ }}, передайте ваши актуальные данные.
Метод возвращает task_id — ID задачи, в результате выполнения которой должен сформироваться отчёт.

#### GET /get_report
Пока отчёт будет формироваться, будет возвращаться статус RUNNING.
Если отчёт сформирован, то метод вернёт статус SUCCESS и report_id.
Сформированный отчёт содержит четыре файла:
custom_research.csv,
user_order_log.csv,
user_activity_log.csv,
price_log.csv.
Файлы отчетов можно получить по URL из параметра s3_path или сформировать URL самостоятельно по следующему шаблону:
`https://storage.yandexcloud.net/s3-sprint3/cohort_{{ your_cohort_number }}/{{ your_nickname }}/project/{{ report_id }}/{{ file_name }}`

#### GET /get_increment
Метод get_increment используется для получения данных за те даты, которые не вошли в основной отчёт. Дата обязательно в формате 2020-01-22T00:00:00.

Если инкремент сформирован, то метод вернёт статус SUCCESS и increment_id. Если инкремент не сформируется, то вернётся NOT FOUND с описанием причины.
Сформированный инкремент содержит три файла: • custom_research_inc.csv, • user_order_log_inc.csv, • user_activity_log_inc.csv, • price_log_inc.csv.
Файлы отчетов можно получить по URL из параметра s3_path или сформировать URL самостоятельно по следующему шаблону:

`https://storage.yandexcloud.net/s3-sprint3/cohort_{{ your_cohort_number }}/{{ your_nickname }}/project/{{ increment_id }}/{{ file_name }}`


#### Ваша задача
Адаптируйте ваш пайплайн для текущей задачи:
Учтите в витрине mart.f_sales статусы shipped и refunded. Все данные в витрине следует считать shipped.
Обновите пайплайн с учётом статусов и backward compatibility

#### Подсказки:
Необходимо провести миграцию схемы и данных в таблице mart.f_sales.
Таблица фактов mart.f_sales должна приобрести вид транзакционной таблицы фактов. Будьте внимательны со статусом refunded.
Чтобы total revenue правильно рассчитывался, строки с refunded добавляйте со знаком -.
Первый инкремент приходит со старым форматом данных — без статуса заказа. Проверьте, что ваш код правильно проставляет статус в этом случае.

### Этап 2
Ваши коллеги решили лучше изучить поведение клиентов. Для этого они хотят исследовать возвращаемость клиентов, или customer retention.
Выяснилось, что на текущий момент отчёт по customer retention строится очень долго. Коллеги попросили вас вычислить нужные метрики в дополнительной витрине.
Эта витрина должна отражать следующую информацию:
Рассматриваемый период — weekly.
Возвращаемость клиентов:
new — кол-во клиентов, которые оформили один заказ за рассматриваемый период;
returning — кол-во клиентов, которые оформили более одного заказа за рассматриваемый период;
refunded — кол-во клиентов, которые вернули заказ за рассматриваемый период.
Доход (revenue) и refunded для каждой категории покупателей.
Благодаря витрине можно будет выяснить, какие категории товаров лучше всего удерживают клиентов.

Коллеги подготовили для вас схему витрины mart.f_customer_retention:
1. new_customers_count — кол-во новых клиентов (тех, которые сделали только один 
заказ за рассматриваемый промежуток времени).
2. returning_customers_count — кол-во вернувшихся клиентов (тех,
которые сделали только несколько заказов за рассматриваемый промежуток времени).
3. refunded_customer_count — кол-во клиентов, оформивших возврат за 
рассматриваемый промежуток времени.
4. period_name — weekly.
5. period_id — идентификатор периода (номер недели или номер месяца).
6. item_id — идентификатор категории товара.
7. new_customers_revenue — доход с новых клиентов.
8. returning_customers_revenue — доход с вернувшихся клиентов.
9. customers_refunded — количество возвратов клиентов.

#### Ваша задача
На основе пайплайна из сквозной задачи спринта наполните витрину mart.f_customer_retention данными по «возвращаемости клиентов» в разрезе недель.
учитывать идемпотентность.

## Порядок выполнения

1. Обновление структуры таблицы staging.user_order_log,
добавляя новое поле status со значением по умолчанию "shipped".
файл update_staging.user_order_log.sql
   
2. Создание дополнительного скрипта на удаление данных из staging.user_order_log
на дату пробега DAG для получения идемпонентности.
файл - staging.user_order_log_delete_date.sql
   
3. Обновление кода заливки данных в mart.f_sales,
прописывая отрицательные значения для статуса "refunded", а также
перезаписывая данные на определенную дату.
файл update_mart.f_sales.sql
   
4. Создание таблицы-витрины mart.f_customer_retention.
файл mart.f_customer_retention.sql

5. Построение кода-скелета логики расчета витрины mart.f_customer_retention
с необходимыми полями
файл mart.f_customer_retention.sql
   
6. Добавление 2х новых тасков в DAG для запуска mart.f_customer_retention.sql
и удаления старых данных из staging.user_order_log
