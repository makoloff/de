# Проект 7-го спринта

### Описание логики

### 1. Проектирование структуры хранилища
Схема Data Lake

![Image alt](https://github.com/makoloff/data_engineering/blob/main/7.%20Data_lake/img/data_lake.jpg)

- сверху - слой сырых данных \ raw data.
- посередине - ods слой с партициями по event type + отдельная директория с геоданными по городам в csv.
- снизу - слой prod с посчитанными 3-мя витринами.


### 2. Создание витрины в разрезе пользователей

Порядок выполнения:
1. сразу читаем все 3 датасета по соответствующим event type и дате
2. для всех трех датасетов делаем кросс-джойн на города и находим соответствующий город и нужный timezone (предварительно считаем его на нулевом этапе)
3. через union объединяем все датасеты (в df = events) и находим последнее событие (df = latest_event) на каждого user id - это actual city
4. все джойним и пишем в слой prod



### 3. Создать витрину в разрезе зон

Порядок выполнения:
1. так же как и в 1й таблице читаем все 3 датасета, кросс-джойним на city, находим соответствующие города для событий и timezone
2. делаем таблицу заготовку base с month/week/city, на которую потом джойнятся все посчитанные агрегаты по соответсвующим ключам и пишем в prod-слой


### 4. Построить витрину для рекомендации друзей

Порядок алгоритма:
1. так же как и в 1й таблице читаем все 3 датасета, кросс-джойним на city, находим соответствующие города для событий и timezone
2. находим связки user_left + user_right, которые подписаны на один и тот же канал
3. находим связки user_left + user_right, которые хотя бы раз переписывались
4. джойним их по типу leftanti, остаются те, которые не переписывались ранее
5. джойним инфу по последнему событию и находим город, если города совпадают, то оставляем запись и пишем в prod-слой


### 5. Автоматизировать обновление витрин

1. составлен DAG, прописаны внутри 4 таски: таска на новую партицию на текущую дату (если появится свежая дата) и 3 отдельные таски на каждую витрину со своими аргументами





### Описание задачи
Коллеги из другого проекта по просьбе вашей команды начали вычислять координаты событий (сообщений, подписок, реакций, регистраций), которые совершили пользователи соцсети. 
Значения координат будут появляться в таблице событий. Пока определяется геопозиция только исходящих сообщений, но уже сейчас можно начать разрабатывать новый функционал.

В продукт планируют внедрить систему рекомендации друзей. Приложение будет предлагать пользователю написать человеку, если пользователь и адресат:
состоят в одном канале, раньше никогда не переписывались, находятся не дальше 1 км друг от друга.

При этом команда хочет лучше изучить аудиторию соцсети, чтобы в будущем запустить монетизацию. Для этого было решено провести геоаналитику:
Выяснить, где находится большинство пользователей по количеству сообщений, лайков и подписок из одной точки.

Посмотреть, в какой точке Австралии регистрируется больше всего новых пользователей.

Определить, как часто пользователи путешествуют и какие города выбирают.
Благодаря такой аналитике в соцсеть можно будет вставить рекламу: приложение сможет учитывать местонахождение пользователя и предлагать тому подходящие услуги компаний-партнёров. 
